name: Approve or Reject Server

on:
  issue_comment:
    types: [created]

jobs:
  handle-command:
    # Only run on PR comments containing /approve or /reject
    if: >
      github.event.issue.pull_request &&
      github.event.issue.pull_request.merged_at &&
      (contains(github.event.comment.body, '/approve') || contains(github.event.comment.body, '/reject'))
    runs-on: ubuntu-latest

    steps:
      # ── 1. Save comment body (before any deletion) ──
      - name: Save comment body
        id: comment
        run: |
          cat <<'COMMENT_EOF' > /tmp/comment_body.txt
          ${{ github.event.comment.body }}
          COMMENT_EOF

      # ── 2. SECURITY: Delete comment if it contains OAuth credentials ──
      - name: Delete comment if contains credentials
        if: contains(github.event.comment.body, 'oauth_client_id=')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "⚠️ Comment contains OAuth credentials — deleting immediately"
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }} -X DELETE
          echo "COMMENT_DELETED=true" >> "$GITHUB_ENV"

      # ── 3. Validate author is OWNER or MEMBER ──
      - name: Validate author association
        env:
          AUTHOR_ASSOCIATION: ${{ github.event.comment.author_association }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
        run: |
          echo "Author: $COMMENT_AUTHOR (association: $AUTHOR_ASSOCIATION)"
          if [[ "$AUTHOR_ASSOCIATION" != "OWNER" && "$AUTHOR_ASSOCIATION" != "MEMBER" ]]; then
            echo "❌ Unauthorized: only OWNER or MEMBER can approve/reject"
            exit 1
          fi

      # ── 4. Determine command ──
      - name: Determine command
        id: command
        run: |
          BODY=$(cat /tmp/comment_body.txt)
          if echo "$BODY" | grep -q '/approve'; then
            echo "action=approve" >> "$GITHUB_OUTPUT"
          elif echo "$BODY" | grep -q '/reject'; then
            echo "action=reject" >> "$GITHUB_OUTPUT"
          else
            echo "❌ No /approve or /reject found"
            exit 1
          fi

      # ── 5. Parse deploy metadata from PR body ──
      - name: Parse deploy metadata
        id: meta
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.issue.number }}
        run: |
          PR_BODY=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER --jq '.body')

          # Extract XTRN_DEPLOY JSON from HTML comment
          DEPLOY_JSON=$(echo "$PR_BODY" | grep -oP '<!-- XTRN_DEPLOY:\K[^}]*}' || true)

          if [[ -z "$DEPLOY_JSON" ]]; then
            echo "❌ No XTRN_DEPLOY metadata found in PR body"
            exit 1
          fi

          echo "Deploy metadata: $DEPLOY_JSON"

          SLUG=$(echo "$DEPLOY_JSON" | jq -r '.slug')
          VERSION=$(echo "$DEPLOY_JSON" | jq -r '.version')
          WORKER_URL=$(echo "$DEPLOY_JSON" | jq -r '.worker_url')
          HAS_OAUTH=$(echo "$DEPLOY_JSON" | jq -r '.has_oauth')
          FIRST_DEPLOY=$(echo "$DEPLOY_JSON" | jq -r '.first_deploy')

          echo "slug=$SLUG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "worker_url=$WORKER_URL" >> "$GITHUB_OUTPUT"
          echo "has_oauth=$HAS_OAUTH" >> "$GITHUB_OUTPUT"
          echo "first_deploy=$FIRST_DEPLOY" >> "$GITHUB_OUTPUT"

          # Version with dots replaced by dashes for Worker name
          VERSION_DASHED=$(echo "$VERSION" | tr '.' '-')
          echo "version_dashed=$VERSION_DASHED" >> "$GITHUB_OUTPUT"

      # ── 6a. REJECT: Tear down Cloudflare Worker ──
      - name: Reject — delete Worker
        if: steps.command.outputs.action == 'reject'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          WORKER_NAME="xtrn-${{ steps.meta.outputs.slug }}-${{ steps.meta.outputs.version_dashed }}"
          echo "Deleting Worker: $WORKER_NAME"
          npx wrangler delete --name "$WORKER_NAME" --force

      - name: Reject — post comment
        if: steps.command.outputs.action == 'reject'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -f body="❌ Server **${{ steps.meta.outputs.slug }}** ${{ steps.meta.outputs.version }} rejected and Worker torn down."

      # ── 6b. APPROVE: Register server via migratecli ──
      - name: Approve — parse OAuth from comment
        if: steps.command.outputs.action == 'approve'
        id: oauth
        run: |
          BODY=$(cat /tmp/comment_body.txt)

          OAUTH_CLIENT_ID=$(echo "$BODY" | grep -oP 'oauth_client_id=\K\S+' || true)
          OAUTH_CLIENT_SECRET=$(echo "$BODY" | grep -oP 'oauth_client_secret=\K\S+' || true)
          OAUTH_CALLBACK_URL=$(echo "$BODY" | grep -oP 'oauth_callback_url=\K\S+' || true)

          echo "::add-mask::$OAUTH_CLIENT_ID"
          echo "::add-mask::$OAUTH_CLIENT_SECRET"

          echo "oauth_client_id=$OAUTH_CLIENT_ID" >> "$GITHUB_OUTPUT"
          echo "oauth_client_secret=$OAUTH_CLIENT_SECRET" >> "$GITHUB_OUTPUT"
          echo "oauth_callback_url=$OAUTH_CALLBACK_URL" >> "$GITHUB_OUTPUT"

      - name: Approve — checkout xtrn repo
        if: steps.command.outputs.action == 'approve'
        uses: actions/checkout@v4
        with:
          repository: AbhinavPalacharla/xtrn
          ref: xtrnlib-new-dev-flow

      - name: Approve — setup Go
        if: steps.command.outputs.action == 'approve'
        uses: actions/setup-go@v5
        with:
          go-version-file: backend/go.mod
          cache-dependency-path: backend/go.sum

      - name: Approve — build migratecli
        if: steps.command.outputs.action == 'approve'
        working-directory: backend
        run: go build -tags production -o migratecli ./cmd/migratecli/

      - name: Approve — run migratecli
        if: steps.command.outputs.action == 'approve'
        env:
          DATABASE_URL_XTRN: ${{ secrets.DATABASE_URL_XTRN }}
        working-directory: backend
        run: |
          ARGS="--url ${{ steps.meta.outputs.worker_url }}"

          if [[ -n "${{ steps.oauth.outputs.oauth_client_id }}" ]]; then
            ARGS="$ARGS --oauth-client-id ${{ steps.oauth.outputs.oauth_client_id }}"
            ARGS="$ARGS --oauth-client-secret ${{ steps.oauth.outputs.oauth_client_secret }}"
            ARGS="$ARGS --oauth-callback-url ${{ steps.oauth.outputs.oauth_callback_url }}"
          fi

          echo "Running: ./migratecli $ARGS"
          ./migratecli $ARGS

      - name: Approve — post comment
        if: steps.command.outputs.action == 'approve'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -f body="✅ Server **${{ steps.meta.outputs.slug }}** ${{ steps.meta.outputs.version }} approved and registered."

      # ── 7. Error handling ──
      - name: Post failure comment
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ACTION="${{ steps.command.outputs.action || 'unknown' }}"
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -f body="❌ ${ACTION^} failed for **${{ steps.meta.outputs.slug || 'unknown' }}** ${{ steps.meta.outputs.version || '' }}. Check [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})."
