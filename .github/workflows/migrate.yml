name: Migrate Server to Database

on:
  workflow_dispatch:
    inputs:
      worker_url:
        description: 'Cloudflare Worker URL'
        required: true
        type: string
      oauth_client_id:
        description: 'OAuth Client ID'
        required: true
        type: string
      oauth_client_secret:
        description: 'OAuth Client Secret'
        required: true
        type: string
      oauth_callback_url:
        description: 'OAuth Callback URL'
        required: true
        type: string
      first_deploy:
        description: 'Is this the first deployment of this server?'
        required: false
        type: boolean
        default: false

jobs:
  migrate:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout xtrn-prod
        uses: actions/checkout@v4
        with:
          repository: AbhinavPalacharla/xtrn
          ref: xtrnlib-new-dev-flow
          path: xtrn-prod

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: xtrn-prod/backend/go.mod

      - name: Build migratecli
        run: |
          cd xtrn-prod/backend
          go build -tags production -o migratecli ./cmd/migratecli/

      - name: Run migration
        env:
          DATABASE_URL_XTRN: ${{ secrets.DATABASE_URL_XTRN }}
        run: |
          cd xtrn-prod/backend
          ./migratecli --url "${{ inputs.worker_url }}" \
            --oauth-client-id "${{ inputs.oauth_client_id }}" \
            --oauth-client-secret "${{ inputs.oauth_client_secret }}" \
            --oauth-callback-url "${{ inputs.oauth_callback_url }}"

      - name: Verify migration
        env:
          DATABASE_URL_XTRN: ${{ secrets.DATABASE_URL_XTRN }}
        run: |
          echo "Migration completed successfully"
          echo "Worker URL: ${{ inputs.worker_url }}"